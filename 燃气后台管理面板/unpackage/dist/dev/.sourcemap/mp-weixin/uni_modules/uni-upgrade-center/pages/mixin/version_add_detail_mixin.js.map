{"version":3,"file":"version_add_detail_mixin.js","sources":["uni_modules/uni-upgrade-center/pages/mixin/version_add_detail_mixin.js"],"sourcesContent":["import {\r\n\tvalidator,\r\n\tenumConverter\r\n} from '@/js_sdk/validator/opendb-app-versions.js';\r\n\r\nexport const platform_iOS = 'iOS';\r\nexport const platform_Android = 'Android';\r\nexport const platform_Harmony = 'Harmony'\r\nconst db = uniCloud.database();\r\n\r\nfunction getValidator(fields) {\r\n\tlet reuslt = {}\r\n\tfor (let key in validator) {\r\n\t\tif (fields.includes(key)) {\r\n\t\t\treuslt[key] = validator[key]\r\n\t\t}\r\n\t}\r\n\treturn reuslt\r\n}\r\n\r\nexport const fields =\r\n\t'appid,name,title,contents,platform,type,version,min_uni_version,url,stable_publish,is_silently,is_mandatory,create_date,store_list'\r\n\r\nexport default {\r\n\tdata() {\r\n\t\treturn {\r\n\t\t\tlabelWidth: '100px',\r\n\t\t\tenableiOSWgt: true, // 是否开启iOS的wgt更新\r\n\t\t\tsilentlyContent: '静默更新：App升级时会在后台下载wgt包并自行安装。新功能在下次启动App时生效',\r\n\t\t\tmandatoryContent: '强制更新：App升级弹出框不可取消',\r\n\t\t\tstablePublishContent: '同时只可有一个线上发行版，线上发行不可更设为下线。\\n未上线可以设为上线发行并自动替换当前线上发行版',\r\n\t\t\tstablePublishContent2: '使用本包替换当前线上发行版',\r\n\t\t\tuploadFileContent: '可下载安装包地址。上传文件到云存储自动填写，也可以手动填写',\r\n\t\t\tminUniVersionContent: '上次使用新Api或打包新模块的App版本',\r\n\t\t\tpriorityContent: '检查更新时，按照优先级从大到小依次尝试跳转商店。如果都跳转失败，则会打开浏览器使用下载链接下载apk安装包',\r\n\t\t\tlatestStableData: [], // 库中最新已上线版\r\n\t\t\tappFileList: null, // 上传包\r\n\t\t\ttype_valuetotext: enumConverter.type_valuetotext,\r\n\t\t\tpreUrl: '',\r\n\t\t\tformData: {\r\n\t\t\t\t\"appid\": \"\",\r\n\t\t\t\t\"name\": \"\",\r\n\t\t\t\t\"title\": \"\",\r\n\t\t\t\t\"contents\": \"\",\r\n\t\t\t\t\"platform\": [],\r\n\t\t\t\t\"store_list\": [],\r\n\t\t\t\t\"type\": \"\",\r\n\t\t\t\t\"version\": \"\",\r\n\t\t\t\t\"min_uni_version\": \"\",\r\n\t\t\t\t\"url\": \"\",\r\n\t\t\t\t\"stable_publish\": false,\r\n\t\t\t\t\"create_date\": null\r\n\t\t\t},\r\n\t\t\tformOptions: {\r\n\t\t\t\t\"platform_localdata\": [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"value\": \"Android\",\r\n\t\t\t\t\t\t\"text\": \"安卓\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"value\": \"iOS\",\r\n\t\t\t\t\t\t\"text\": \"苹果\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"value\": \"Harmony\",\r\n\t\t\t\t\t\t\"text\": \"鸿蒙 Next\"\r\n\t\t\t\t\t}\r\n\t\t\t\t],\r\n\t\t\t\t\"type_localdata\": [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"value\": \"native_app\",\r\n\t\t\t\t\t\t\"text\": \"原生App安装包\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"value\": \"wgt\",\r\n\t\t\t\t\t\t\"text\": \"App资源包\"\r\n\t\t\t\t\t}\r\n\t\t\t\t]\r\n\t\t\t},\r\n\t\t\trules: {\r\n\t\t\t\t...getValidator([\r\n\t\t\t\t\t\"appid\", \"contents\", \"platform\", \"type\",\r\n\t\t\t\t\t\"version\", \"min_uni_version\", \"url\", \"stable_publish\",\r\n\t\t\t\t\t\"title\", \"name\", \"is_silently\", \"is_mandatory\", \"store_list\"\r\n\t\t\t\t])\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tonReady() {\r\n\t\tthis.$refs.form.setRules(this.rules)\r\n\t},\r\n\tcomputed: {\r\n\t\tisWGT() {\r\n\t\t\treturn this.formData.type === 'wgt'\r\n\t\t},\r\n\t\tisNativeApp() {\r\n\t\t\treturn this.formData.type === 'native_app'\r\n\t\t},\r\n\t\tisiOS() {\r\n\t\t\treturn this.formData.platform.includes(platform_iOS);\r\n\t\t},\r\n\t\tisAndroid() {\r\n\t\t\treturn this.formData.platform.includes(platform_Android)\r\n\t\t},\r\n\t\tisHarmony() {\r\n\t\t\treturn this.formData.platform.includes(platform_Harmony)\r\n\t\t},\r\n\t\thasPackage() {\r\n\t\t\treturn this.appFileList && !!Object.keys(this.appFileList).length\r\n\t\t},\r\n\t\tfileExtname() {\r\n\t\t\treturn this.isWGT ? ['wgt'] : ['apk']\r\n\t\t},\r\n\t\tplatformLocaldata() {\r\n\t\t\treturn !this.isWGT ? this.formOptions.platform_localdata : this.enableiOSWgt ? this.formOptions\r\n\t\t\t\t.platform_localdata : [this.formOptions.platform_localdata[0], this.formOptions.platform_localdata[2]]\r\n\t\t},\r\n\t\tuni_platform() {\r\n\t\t\tif (this.isiOS) return platform_iOS.toLocaleLowerCase()\r\n\t\t\telse if (this.isAndroid) return platform_Android.toLocaleLowerCase()\r\n\t\t\treturn platform_Harmony.toLocaleLowerCase()\r\n\t\t},\r\n\t\tenableUploadPackage() {\r\n\t\t\treturn this.isWGT || !(this.isiOS || this.isHarmony)\r\n\t\t},\r\n\t\turlLabel() {\r\n\t\t\tif (this.isWGT || this.isAndroid) return '下载链接'\r\n\t\t\tif (this.isiOS) return 'AppStore'\r\n\t\t\telse if (this.isHarmony) return '应用商店'\r\n\t\t},\r\n\t\tisApk() {\r\n\t\t\tconst apkIndex = this.formData.url.indexOf('apk')\r\n\t\t\treturn this.formData.url && (apkIndex > -1 && apkIndex === this.formData.url.length - 3)\r\n\t\t}\r\n\t},\r\n\tmethods: {\r\n\t\tgetStoreList(appid) {\r\n\t\t\treturn db.collection('opendb-app-list')\r\n\t\t\t\t.where({\r\n\t\t\t\t\tappid\r\n\t\t\t\t})\r\n\t\t\t\t.get()\r\n\t\t\t\t.then(res => {\r\n\t\t\t\t\tconst data = res.result.data[0]\r\n\t\t\t\t\treturn data ? data.store_list || [] : []\r\n\t\t\t\t})\r\n\t\t},\r\n\t\tpackageUploadSuccess(res) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ticon: 'success',\r\n\t\t\t\ttitle: '上传成功',\r\n\t\t\t\tduration: 800\r\n\t\t\t})\r\n\t\t\tthis.preUrl = this.formData.url\r\n\t\t\tthis.formData.url = res.tempFilePaths[0]\r\n\t\t},\r\n\t\tdeleteFile(fileList) {\r\n\t\t\treturn this.$request('deleteFile', {\r\n\t\t\t\tfileList\r\n\t\t\t}, {\r\n\t\t\t\tfunctionName: 'uni-upgrade-center'\r\n\t\t\t})\r\n\t\t},\r\n\t\tasync packageDelete(res) {\r\n\t\t\tif (!this.hasPackage) return;\r\n\t\t\tawait this.deleteFile([res.tempFilePath])\r\n\t\t\tuni.showToast({\r\n\t\t\t\ticon: 'success',\r\n\t\t\t\ttitle: '删除成功',\r\n\t\t\t\tduration: 800\r\n\t\t\t})\r\n\t\t\tthis.formData.url = this.preUrl\r\n\t\t\tthis.$refs.form.clearValidate('url')\r\n\t\t},\r\n\t\tselectFile() {\r\n\t\t\tif (this.hasPackage) {\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\ttitle: '只可上传一个文件，请删除已上传后重试',\r\n\t\t\t\t\tduration: 1000\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\tcreateCenterRecord(value) {\r\n\t\t\treturn {\r\n\t\t\t\t...value,\r\n\t\t\t\tuni_platform: this.uni_platform,\r\n\t\t\t\tcreate_env: 'upgrade-center'\r\n\t\t\t}\r\n\t\t},\r\n\t\tcreateCenterQuery({\r\n\t\t\tappid\r\n\t\t}) {\r\n\t\t\treturn {\r\n\t\t\t\tappid,\r\n\t\t\t\tcreate_env: 'upgrade-center'\r\n\t\t\t}\r\n\t\t},\r\n\t\tcreateStatQuery({\r\n\t\t\tappid,\r\n\t\t\ttype,\r\n\t\t\tversion,\r\n\t\t\tuni_platform\r\n\t\t}) {\r\n\t\t\treturn {\r\n\t\t\t\tappid,\r\n\t\t\t\ttype,\r\n\t\t\t\tversion,\r\n\t\t\t\tuni_platform: uni_platform ? uni_platform : this.uni_platform,\r\n\t\t\t\tcreate_env: 'uni-stat',\r\n\t\t\t\tstable_publish: false\r\n\t\t\t}\r\n\t\t},\r\n\t\ttoUrl(url){\r\n\t\t\t// #ifdef H5\r\n\t\t\twindow.open(url);\r\n\t\t\t// #endif\r\n\t\t\t// #ifndef H5\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '请在浏览器中打开',\r\n\t\t\t\ticon: 'none'\r\n\t\t\t});\r\n\t\t\t// #endif\r\n\t\t},\r\n\t\tgetCloudStorageConfig(){\r\n\t\t\treturn uni.getStorageSync('uni-admin-cloud-storage-config') || {};\r\n\t\t},\r\n\t\tsetCloudStorageConfig(data={}){\r\n\t\t\tuni.setStorageSync('uni-admin-cloud-storage-config', data);\r\n\t\t},\r\n\t\t// 临时方法，后面会优化\r\n\t\tsetCloudStorage(data){\r\n\t\t\t// uniCloud.setCloudStorage 不是标准的API，临时挂载在uniCloud对象上的，后面会优化\r\n\t\t\tif (typeof uniCloud.setCloudStorage === \"function\") {\r\n\t\t\t\tuniCloud.setCloudStorage(data);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["uniCloud","fields","validator","enumConverter","uni"],"mappings":"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"}