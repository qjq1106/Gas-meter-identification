{"version":3,"file":"uploadFileForExtStorage.js","sources":["js_sdk/ext-storage/uploadFileForExtStorage.js"],"sourcesContent":["/**\r\n * 设置 uniCloud.uploadFile 默认上传到扩展存储\r\n * @param {String} provider 云储存供应商\r\n * \t@value unicloud\t\t\t\t内置存储\r\n * \t@value extStorage \t\t扩展存储\r\n * @param {String} domain 自定义域名，仅扩展存储有效\r\n * @param {Boolean} fileID2fileURL 是否将fileID转为fileURL\r\n * @param {Function} uploadFileOptions 获取上传参数的函数，仅扩展存储有效\r\n */\r\nfunction init(options = {}) {\r\n\tlet {\r\n\t\tprovider: defaultProvider,\r\n\t} = options;\r\n\tlet originalDefaultProvider = defaultProvider;\r\n\tlet extStorage = new ExtStorage(options);\r\n\r\n\tconst uploadFile = uniCloud.uploadFile;\r\n\tuniCloud.uploadFile = (...e) => {\r\n\t\tlet options = e[0] || {};\r\n\t\tlet {\r\n\t\t\tprovider = defaultProvider\r\n\t\t} = options;\r\n\t\tif (provider === \"extStorage\") {\r\n\t\t\treturn extStorage.uploadFile(...e);\r\n\t\t} else {\r\n\t\t\treturn uploadFile(...e);\r\n\t\t}\r\n\t}\r\n\r\n\tconst getTempFileURL = uniCloud.getTempFileURL;\r\n\tuniCloud.getTempFileURL = (...e) => {\r\n\t\tlet options = e[0] || {};\r\n\t\tlet {\r\n\t\t\tprovider = defaultProvider\r\n\t\t} = options;\r\n\t\tif (provider === \"extStorage\") {\r\n\t\t\treturn extStorage.getTempFileURL(...e);\r\n\t\t} else {\r\n\t\t\treturn getTempFileURL(...e);\r\n\t\t}\r\n\t}\r\n\r\n\tconst deleteFile = uniCloud.deleteFile;\r\n\tuniCloud.deleteFile = (...e) => {\r\n\t\tlet options = e[0] || {};\r\n\t\tlet {\r\n\t\t\tprovider = defaultProvider\r\n\t\t} = options;\r\n\t\tif (provider === \"extStorage\") {\r\n\t\t\treturn extStorage.deleteFile(...e);\r\n\t\t} else {\r\n\t\t\treturn deleteFile(...e);\r\n\t\t}\r\n\t}\r\n\r\n\tuniCloud.setCloudStorage = (data={}) => {\r\n\t\tlet {\r\n\t\t\tprovider,\r\n\t\t\tdomain,\r\n\t\t\tfileID2fileURL,\r\n\t\t} = data;\r\n\t\tif (provider === null) {\r\n\t\t\tdefaultProvider = originalDefaultProvider;\r\n\t\t} else if (provider) {\r\n\t\t\tdefaultProvider = provider;\r\n\t\t}\r\n\t\tif (domain) extStorage.domain = domain;\r\n\t\tif (fileID2fileURL) extStorage.fileID2fileURL = fileID2fileURL;\r\n\t}\r\n\r\n}\r\n\r\nexport default {\r\n\tinit\r\n}\r\n\r\nclass ExtStorage {\r\n\tconstructor(data = {}) {\r\n\t\tlet {\r\n\t\t\tuploadFileOptions,\r\n\t\t\tdomain,\r\n\t\t\tfileID2fileURL\r\n\t\t} = data;\r\n\t\tthis.uploadFileOptions = uploadFileOptions;\r\n\t\tthis.domain = domain;\r\n\t\tthis.fileID2fileURL = fileID2fileURL;\r\n\t}\r\n\r\n\t// 上传文件\r\n\tuploadFile(options) {\r\n\t\tlet {\r\n\t\t\tfilePath,\r\n\t\t\tcloudPath,\r\n\t\t} = options;\r\n\t\tconst promiseRes = new Promise(async (resolve, reject) => {\r\n\t\t\ttry {\r\n\t\t\t\tconst uploadFileOptionsRes = await this.uploadFileOptions({\r\n\t\t\t\t\tcloudPath,\r\n\t\t\t\t\tdomain: this.domain\r\n\t\t\t\t});\r\n\t\t\t\tconst uploadTask = uni.uploadFile({\r\n\t\t\t\t\t...uploadFileOptionsRes.uploadFileOptions, // 上传文件所需参数\r\n\t\t\t\t\tfilePath, // 本地文件路径\r\n\t\t\t\t\tsuccess: (uploadFileRes) => {\r\n\t\t\t\t\t\tif (uploadFileRes.statusCode !== 200) {\r\n\t\t\t\t\t\t\tconst err = uploadFileRes;\r\n\t\t\t\t\t\t\tif (typeof options.fail === \"function\") options.fail(err);\r\n\t\t\t\t\t\t\treject(err);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tconst res = {\r\n\t\t\t\t\t\t\t\tcloudPath: uploadFileOptionsRes.cloudPath, // 文件云端路径\r\n\t\t\t\t\t\t\t\tfileID: uploadFileOptionsRes.fileID, // 文件ID\r\n\t\t\t\t\t\t\t\tfileURL: uploadFileOptionsRes.fileURL, // 文件URL（如果是私有权限，则此URL是无法直接访问的）\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tif (this.fileID2fileURL) {\r\n\t\t\t\t\t\t\t\tres.fileID = `https://${this.domain}/${res.cloudPath}`;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (typeof options.success === \"function\") options.success(res);\r\n\t\t\t\t\t\t\tresolve(res);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tif (typeof options.fail === \"function\") options.fail(err);\r\n\t\t\t\t\t\treject(err);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcomplete: () => {\r\n\t\t\t\t\t\tif (typeof options.complete === \"function\") options.complete();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// 监听上传进度\r\n\t\t\t\tuploadTask.onProgressUpdate((progressEvent) => {\r\n\t\t\t\t\tif (typeof options.onUploadProgress === \"function\") {\r\n\t\t\t\t\t\tconst total = progressEvent.totalBytesExpectedToSend;\r\n\t\t\t\t\t\tconst loaded = progressEvent.totalBytesSent;\r\n\t\t\t\t\t\tconst progress = Math.round(loaded * 100 / total);\r\n\t\t\t\t\t\toptions.onUploadProgress({\r\n\t\t\t\t\t\t\ttotal,\r\n\t\t\t\t\t\t\tloaded,\r\n\t\t\t\t\t\t\tprogress\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} catch (err) {\r\n\t\t\t\tif (typeof options.fail === \"function\") options.fail(err);\r\n\t\t\t\treject(err);\r\n\t\t\t\tif (typeof options.complete === \"function\") options.complete();\r\n\t\t\t}\r\n\t\t});\r\n\t\tpromiseRes.catch(() => {\r\n\r\n\t\t});\r\n\t\treturn promiseRes;\r\n\t}\r\n\r\n\t// 获取临时文件下载地址\r\n\tgetTempFileURL(options = {}) {\r\n\t\tlet {\r\n\t\t\tfileList\r\n\t\t} = options;\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tlet res = {\r\n\t\t\t\tfileList: fileList.map((item, index) => {\r\n\t\t\t\t\tlet cloudPath = getCloudPath(item);\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tfileID: item,\r\n\t\t\t\t\t\ttempFileURL: `https://${this.domain}/${cloudPath}`\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tif (typeof options.success === \"function\") options.success(res);\r\n\t\t\tresolve(res);\r\n\t\t\tif (typeof options.complete === \"function\") options.complete();\r\n\t\t});\r\n\t}\r\n\r\n\t// 删除文件\r\n\tdeleteFile(options = {}) {\r\n\t\t// 扩展存储不允许前端删除文件（故此处直接返回）\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tlet res = {\r\n\t\t\t\tfileList: []\r\n\t\t\t};\r\n\t\t\tif (typeof options.success === \"function\") options.success(res);\r\n\t\t\tresolve(res);\r\n\t\t\tif (typeof options.complete === \"function\") options.complete();\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nfunction getCloudPath(cloudPath) {\r\n\tconst qiniuPrefix = 'qiniu://';\r\n\tif (cloudPath.indexOf(qiniuPrefix) === 0) {\r\n\t\tcloudPath = cloudPath.substring(qiniuPrefix.length);\r\n\t} else if (cloudPath.indexOf('http://') === 0 || cloudPath.indexOf('https://') === 0) {\r\n\t\tlet startIndex = cloudPath.indexOf('://') + 3;\r\n\t\tstartIndex = cloudPath.indexOf('/', startIndex);\r\n\t\tlet endIndex = cloudPath.indexOf('?') === -1 ? cloudPath.length : cloudPath.indexOf('?');\r\n\t\tendIndex = cloudPath.indexOf('#') !== -1 && cloudPath.indexOf('#') < endIndex ? cloudPath.indexOf('#') : endIndex;\r\n\t\tcloudPath = cloudPath.substring(startIndex + 1, endIndex);\r\n\t}\r\n\treturn cloudPath\r\n}\r\n"],"names":["uniCloud","options","uni"],"mappings":"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"}