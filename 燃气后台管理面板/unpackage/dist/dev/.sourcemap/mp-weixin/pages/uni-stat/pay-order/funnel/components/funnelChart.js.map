{"version":3,"file":"funnelChart.js","sources":["pages/uni-stat/pay-order/funnel/components/funnelChart.vue"],"sourcesContent":["<template>\r\n\t<view class=\"uni-stat--x p-m\">\r\n\t\t<view class=\"uni-stat-card-header\">漏斗分析</view>\n\t\t<!-- 时间纬度 -->\n\t\t<view class=\"flex\">\n\t\t\t<uni-stat-tabs type=\"box\" :current=\"dateTabs.index\" :tabs=\"dateTabs.list\" @change=\"dateTabsChange\" />\n\t\t\t<uni-datetime-picker type=\"date\" v-model=\"dateTabs.time\" :end=\"Date.now()\" return-type=\"timestamp\" :clear-icon=\"false\" class=\"uni-stat-datetime-picker\" @change=\"datePickerChange\" />\n\t\t\t<view class=\"uni-stat--tips\" v-if=\"dateTabs.timeStr\">当前时间范围：{{ dateTabs.timeStr }}</view>\n\t\t</view>\n\t\t<!-- 漏斗 -->\r\n\t\t<view class=\"uni-charts-box\" v-if=\"!notData\">\r\n\t\t\t<qiun-data-charts type=\"funnel\" :chartData=\"chartData\" :opts=\"opts\" :errorMessage=\"errorMessage\" />\n\t\t</view>\n\t\t<view class=\"uni-charts-box flex center\" v-else>\n\t\t\t<view >暂无数据</view>\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\timport {\r\n\t\tmapfields,\r\n\t\tstringifyQuery,\r\n\t\tstringifyField,\r\n\t\tstringifyGroupField,\r\n\t\tgetTimeOfSomeDayAgo,\r\n\t\tdivision,\r\n\t\tformat,\r\n\t\tformatDate,\r\n\t\tparseDateTime,\r\n\t\tgetFieldTotal,\r\n\t\tdebounce\r\n\t} from '@/js_sdk/uni-stat/util.js'\r\n\timport timeUtil from \"@/js_sdk/uni-stat/timeUtil.js\"\n\timport {\r\n\t\tfieldsMap,\r\n\t} from '../fieldsMap.js'\r\n\texport default {\r\n\t\tprops: {\r\n\t\t\t// 组件外部查询条件，一般包含 appid version_id platform_id\r\n\t\t\tquery: {\r\n\t\t\t\ttype: [Object],\r\n\t\t\t\tdefault: function() {\r\n\t\t\t\t\treturn {}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\ttableName: 'uni-stat-pay-result',\n\t\t\t\tfieldsMap,\r\n\t\t\t\tchartData: {},\n\t\t\t\terrorMessage:\"\",\n\t\t\t\tnotData: false,\r\n\t\t\t\topts: {\r\n\t\t\t\t\tcolor: [\"#1890FF\", \"#91CB74\", \"#FAC858\", \"#EE6666\", \"#73C0DE\", \"#3CA272\", \"#FC8452\", \"#9A60B4\", \"#ea7ccc\"],\r\n\t\t\t\t\tpadding: [15, 15, 0, 15],\n\t\t\t\t\textra: {\r\n\t\t\t\t\t\tfunnel: {\r\n\t\t\t\t\t\t\tactiveOpacity: 0.3,\r\n\t\t\t\t\t\t\tactiveWidth: 10,\r\n\t\t\t\t\t\t\tborder: true,\r\n\t\t\t\t\t\t\tborderWidth: 2,\r\n\t\t\t\t\t\t\tborderColor: \"#FFFFFF\",\r\n\t\t\t\t\t\t\tfillOpacity: 1,\r\n\t\t\t\t\t\t\tlabelAlign: \"right\",\n\t\t\t\t\t\t\tlinearType: \"custom\",\n\t\t\t\t\t\t\tminSize: 20\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t// 时间选项\r\n\t\t\t\tdateTabs: {\r\n\t\t\t\t\ttime: Date.now(),\n\t\t\t\t\ttimeStr:\"\",\r\n\t\t\t\t\tindex: 0,\r\n\t\t\t\t\tlist: [\r\n\t\t\t\t\t\t{ _id: \"day\", name: '日维度' },\r\n\t\t\t\t\t\t{ _id: \"week\", name: '周维度' },\r\n\t\t\t\t\t\t{ _id: \"month\", name: '月维度' }\r\n\t\t\t\t\t]\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tcreated() {\r\n\t\t\tthis.getCloudDataDebounce = debounce(() => {\n\t\t\t\tthis.getCloudData();\r\n\t\t\t}, 400);\n\t\t\tthis.getCloudDataDebounce();\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tcalcPercentage(v1, v2) {\r\n\t\t\t\treturn v2 > 0 ? parseFloat((v1 / v2 * 100).toFixed(2)) : 0;\r\n\t\t\t},\n\t\t\t// 获取云端数据\r\n\t\t\tgetCloudData() {\n\t\t\t\tlet query = this.query;\n\t\t\t\tif (!query.appid){\n\t\t\t\t\tthis.errorMessage = \"请先选择应用\";\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.errorMessage = \"\";\n\t\t\t\tlet insideQuery = this.getWhere();\n\t\t\t\tlet where = {\r\n\t\t\t\t\t...query,\r\n\t\t\t\t\t...insideQuery\r\n\t\t\t\t};\r\n\t\t\t\tconst day = 24 * 60 * 60 * 1000;\r\n\t\t\t\tlet start_time;\r\n\t\t\t\twhere = stringifyQuery(where, false, ['uni_platform']);\r\n\t\t\t\t//console.log('where: ', where);\n\t\t\t\tconst db = uniCloud.database();\r\n\t\t\t\tconst subTable = db.collection(this.tableName)\r\n\t\t\t\t\t.where(where)\r\n\t\t\t\t\t.field(`${stringifyField(fieldsMap)}, dimension, stat_date.date_str as stat_time, start_time`)\r\n\t\t\t\t\t.groupBy(`null`)\r\n\t\t\t\t\t.groupField(stringifyGroupField(fieldsMap))\r\n\t\t\t\t\t.get()\r\n\t\t\t\t\t.then(res => {\n\t\t\t\t\t\tlet data = res.result.data;\n\t\t\t\t\t\tif (!data.length) {\n\t\t\t\t\t\t\tthis.errorMessage = \"暂无数据\";\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.errorMessage = \"\";\r\n\t\t\t\t\t\t//console.log('data: ', data);\r\n\t\t\t\t\t\tdata.map((item) => {\r\n\t\t\t\t\t\t\tfor (let key in item) {\r\n\t\t\t\t\t\t\t\tif (key.indexOf(\"_amount\") > 1) {\r\n\t\t\t\t\t\t\t\t\titem[key] = Number((item[key] / 100).toFixed(2));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tlet {\r\n\t\t\t\t\t\t\tactivity_device_count = 0,\r\n\t\t\t\t\t\t\tactivity_user_count = 0,\r\n\t\t\t\t\t\t\tpay_user_count = 0,\r\n\t\t\t\t\t\t} = data[0] || {};\n\t\t\t\t\t\tthis.notData = !activity_device_count && !activity_user_count && !pay_user_count ? true : false;\n\t\t\t\t\t\tlet chartData = {\n\t\t\t\t\t\t\tseries: [{\r\n\t\t\t\t\t\t\t\tdata: [\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\"name\": \"活跃设备数量\",\n\t\t\t\t\t\t\t\t\t\t\"value\": activity_device_count,\n\t\t\t\t\t\t\t\t\t\t\"centerText\": `${activity_device_count}`,\r\t\t\t\t\t\t\t\t\t\t\"labelText\": `活跃设备数`\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\"name\": \"活跃用户数量\",\r\n\t\t\t\t\t\t\t\t\t\t\"value\": activity_user_count,\r\n\t\t\t\t\t\t\t\t\t\t\"centerText\": `${activity_user_count}`,\r\n\t\t\t\t\t\t\t\t\t\t\"labelText\": `活跃用户数（用户转化率：${this.calcPercentage(activity_user_count,activity_device_count)}%）`\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\"name\": \"支付用户数量\",\r\n\t\t\t\t\t\t\t\t\t\t\"value\": pay_user_count,\r\n\t\t\t\t\t\t\t\t\t\t\"centerText\": `${pay_user_count}`,\r\n\t\t\t\t\t\t\t\t\t\t\"labelText\": `支付用户数（支付转化率：${this.calcPercentage(pay_user_count,activity_user_count)}%）`,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t],\r\n\t\t\t\t\t\t\t}]\r\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthis.chartData = chartData;\n\t\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t// 监听 - 日期标签更改\r\n\t\t\tdateTabsChange(id, index) {\r\n\t\t\t\tthis.dateTabs.index = index;\r\n\t\t\t\tthis.getCloudData();\r\n\t\t\t},\n\t\t\t// 监听 - 日期选择更改\n\t\t\tdatePickerChange(time) {\n\t\t\t\tthis.dateTabs.time = time;\n\t\t\t\tthis.getCloudData();\n\t\t\t},\r\n\t\t\t// 获取查询条件\r\n\t\t\tgetWhere() {\r\n\t\t\t\tlet time = this.dateTabs.time; // 当前选择的时间\r\n\t\t\t\tlet dimension = this.dateTabs.list[this.dateTabs.index]._id || \"day\"; // 获取时间纬度\r\n\t\t\t\tlet start_time = [];\r\n\t\t\t\tif (dimension === \"day\") {\r\n\t\t\t\t\tlet { startTime, endTime } = timeUtil.getOffsetStartAndEnd(\"day\", 0, time);\r\n\t\t\t\t\tstart_time = [startTime, endTime];\r\n\t\t\t\t} else if (dimension === \"week\") {\r\n\t\t\t\t\tlet { startTime, endTime } = timeUtil.getOffsetStartAndEnd(\"week\",0, time);\r\n\t\t\t\t\tstart_time = [startTime, endTime];\r\n\t\t\t\t} else if (dimension === \"month\") {\r\n\t\t\t\t\tlet { startTime, endTime } = timeUtil.getOffsetStartAndEnd(\"month\", 0, time);\r\n\t\t\t\t\tstart_time = [startTime, endTime];\r\n\t\t\t\t}\r\n\t\t\t\tthis.dateTabs.timeStr = `${timeUtil.timeFormat(start_time[0])} ~ ${timeUtil.timeFormat(start_time[1])}`;\r\n\t\t\t\treturn {\r\n\t\t\t\t\tdimension, // 时间纬度\r\n\t\t\t\t\tstart_time, // 时间范围\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\twatch: {\r\n\t\t\tquery: {\r\n\t\t\t\tdeep: true,\r\n\t\t\t\thandler(val) {\n\t\t\t\t\tthis.getCloudDataDebounce();\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tcomputed: {\r\n\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.flex.center{\n\tjustify-content: center;\n\talign-items: center;\n\tcolor: #666;\n}\r\n</style>\n"],"names":["fieldsMap","debounce","stringifyQuery","uniCloud","stringifyField","stringifyGroupField","timeUtil"],"mappings":"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"}