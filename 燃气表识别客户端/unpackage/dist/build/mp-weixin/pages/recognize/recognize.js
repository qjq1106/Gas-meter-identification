"use strict";const e=require("../../common/vendor.js"),t={data:()=>({imageUrl:"",recognizing:!1,todayCount:0,totalCount:0,showForm:!1,buildingIndex:0,buildingOptions:["1å·æ¥¼","2å·æ¥¼","3å·æ¥¼","4å·æ¥¼","5å·æ¥¼","6å·æ¥¼","7å·æ¥¼","8å·æ¥¼","9å·æ¥¼","10å·æ¥¼","11å·æ¥¼","12å·æ¥¼"],formData:{building:"1å·æ¥¼",detailAddress:"",remarks:""},shootingTips:[{title:"å…‰çº¿å……è¶³",desc:"ç¡®ä¿ç‡ƒæ°”è¡¨æ•°å­—æ˜¾ç¤ºæ¸…æ™°",emoji:"ðŸ’¡"},{title:"æ°´å¹³æ‹æ‘„",desc:"ä¿æŒæ‰‹æœºä¸Žç‡ƒæ°”è¡¨å¹³è¡Œ",emoji:"ðŸ“"},{title:"å®Œæ•´æ˜¾ç¤º",desc:"ç¡®ä¿è¯»æ•°å®Œå…¨æ˜¾ç¤ºåœ¨ç”»é¢ä¸­",emoji:"ðŸŽ¯"},{title:"é¿å…åå…‰",desc:"é˜²æ­¢é˜´å½±é®æŒ¡æ•°å­—åŒºåŸŸ",emoji:"ðŸš«"},{title:"æ ¸å¯¹è¯»æ•°",desc:"è¯†åˆ«åŽè¯·éªŒè¯ç»“æžœå‡†ç¡®æ€§",emoji:"âœ…"}]}),onLoad(){this.loadStatistics()},onShow(){this.loadStatistics()},methods:{async loadStatistics(){try{const t=e.tr.importObject("gasMeter"),o=await t.getReports("å…¨éƒ¨");if(0===o.errCode){const e=o.data;this.totalCount=e.length;const t=(new Date).toISOString().split("T")[0],i=t.replace(/-/g,"/");this.todayCount=e.filter((e=>e.date===i||e.updateTime&&e.updateTime.startsWith(t))).length}}catch(t){console.log("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:",t)}},chooseImage(){const t=this;e.index.showActionSheet({itemList:["æ‹ç…§","ä»Žç›¸å†Œé€‰æ‹©"],success(e){0===e.tapIndex?t.takePhoto():t.chooseFromAlbum()}})},takePhoto(){const t=this;e.index.chooseImage({count:1,sourceType:["camera"],success(o){t.imageUrl=o.tempFilePaths[0],e.index.showToast({title:"æ‹ç…§æˆåŠŸï¼Œè¯·ç»§ç»­å¡«å†™ä¿¡æ¯",icon:"success",duration:1500})},fail(){e.index.showToast({title:"æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:2e3})}})},chooseFromAlbum(){const t=this;e.index.chooseImage({count:1,sourceType:["album"],success(o){t.imageUrl=o.tempFilePaths[0],e.index.showToast({title:"å›¾ç‰‡é€‰æ‹©æˆåŠŸï¼Œè¯·ç»§ç»­å¡«å†™ä¿¡æ¯",icon:"success",duration:1500})},fail(){e.index.showToast({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:2e3})}})},clearImage(){this.imageUrl="",this.showForm=!1,this.formData={building:"1å·æ¥¼",detailAddress:"",remarks:""},this.buildingIndex=0},showInfoForm(){this.showForm=!0},backToPhoto(){this.showForm=!1},onBuildingChange(e){this.buildingIndex=e.detail.value,this.formData.building=this.buildingOptions[e.detail.value]},async confirmAndRecognize(){if(this.imageUrl)if(this.formData.detailAddress.trim()){this.recognizing=!0;try{const o=await this.convertImageToBase64(this.imageUrl);let i="";try{i=(await e.tr.uploadFile({filePath:this.imageUrl,cloudPath:`gas-meter-images/${Date.now()}-${Math.random().toString(36).substr(2,9)}.jpg`,cloudPathAsRealPath:!0})).fileID}catch(t){console.log("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œè¯†åˆ«ä½†ä¸ä¿å­˜å›¾ç‰‡URL:",t)}const a=e.tr.importObject("gasMeter"),s=`${this.formData.building} ${this.formData.detailAddress}`,n=await a.recognizeGasMeter(o,s,this.formData.building,this.formData.remarks,i);if(this.recognizing=!1,0===n.errCode){this.todayCount++,this.totalCount++,e.index.showToast({title:"ðŸŽ‰ è¯†åˆ«æˆåŠŸï¼æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...",icon:"success",duration:2e3});const t=this.imageUrl,o=this.formData.remarks;this.showForm=!1,this.imageUrl="",this.formData={building:"1å·æ¥¼",detailAddress:"",remarks:""},this.buildingIndex=0,setTimeout((()=>{e.index.navigateTo({url:`/pages/reportDetail/reportDetail?reportId=${n.data.reportId}&reading=${n.data.reading}&address=${n.data.address}&date=${n.data.date}&time=${n.data.time}&imageUrl=${encodeURIComponent(t)}&integerPart=${n.data.integerPart}&decimalPart=${n.data.decimalPart}&remarks=${encodeURIComponent(o)}`})}),1500)}else e.index.showModal({title:"è¯†åˆ«å¤±è´¥",content:n.errMsg||"æ— æ³•è¯†åˆ«ç‡ƒæ°”è¡¨è¯»æ•°ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æ¸…æ™°ï¼Œç¡®ä¿æ•°å­—æ˜¾ç¤ºå®Œæ•´ã€‚",confirmText:"é‡æ–°æ‹ç…§",showCancel:!0,cancelText:"ç¨åŽå†è¯•",success:e=>{e.confirm&&this.clearImage()}})}catch(o){this.recognizing=!1,console.error("è¯†åˆ«å‡ºé”™:",o),e.index.showModal({title:"ç½‘ç»œé”™è¯¯",content:"è¯†åˆ«è¿‡ç¨‹ä¸­ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥åŽé‡è¯•ã€‚",confirmText:"é‡æ–°è¯†åˆ«",showCancel:!0,cancelText:"ç¨åŽå†è¯•",success:e=>{e.confirm&&this.confirmAndRecognize()}})}}else e.index.showToast({title:"è¯·å¡«å†™è¯¦ç»†åœ°å€ä¿¡æ¯",icon:"none",duration:2e3});else e.index.showToast({title:"è¯·å…ˆé€‰æ‹©å›¾ç‰‡",icon:"none"})},convertImageToBase64:t=>new Promise(((o,i)=>{e.index.getFileSystemManager().readFile({filePath:t,encoding:"base64",success:e=>{o(e.data)},fail:e=>{i(e)}})}))}};const o=e._export_sfc(t,[["render",function(t,o,i,a,s,n){return e.e({a:!s.imageUrl},s.imageUrl?{b:s.imageUrl}:{},{c:e.o(((...e)=>n.chooseImage&&n.chooseImage(...e))),d:!s.imageUrl},s.imageUrl?{}:{e:e.o(((...e)=>n.takePhoto&&n.takePhoto(...e))),f:e.o(((...e)=>n.chooseFromAlbum&&n.chooseFromAlbum(...e)))},{g:s.imageUrl&&!s.showForm},s.imageUrl&&!s.showForm?{h:e.o(((...e)=>n.clearImage&&n.clearImage(...e))),i:e.o(((...e)=>n.showInfoForm&&n.showInfoForm(...e)))}:{},{j:s.showForm},s.showForm?{k:e.t(s.buildingOptions[s.buildingIndex]),l:e.o(((...e)=>n.onBuildingChange&&n.onBuildingChange(...e))),m:s.buildingIndex,n:s.buildingOptions,o:s.formData.detailAddress,p:e.o((e=>s.formData.detailAddress=e.detail.value)),q:s.formData.remarks,r:e.o((e=>s.formData.remarks=e.detail.value)),s:e.o(((...e)=>n.backToPhoto&&n.backToPhoto(...e))),t:e.t(s.recognizing?"â³":"âœ¨"),v:e.t(s.recognizing?"è¯†åˆ«ä¸­...":"ç¡®è®¤è¯†åˆ«"),w:s.recognizing?1:"",x:e.o(((...e)=>n.confirmAndRecognize&&n.confirmAndRecognize(...e)))}:{},{y:e.f(s.shootingTips,((t,o,i)=>({a:e.t(o+1),b:e.t(t.title),c:e.t(t.desc),d:e.t(t.emoji),e:o}))),z:e.t(s.todayCount),A:e.t(s.totalCount)})}],["__scopeId","data-v-e74088a2"]]);wx.createPage(o);
