"use strict";const e=require("../../common/vendor.js"),t={data:()=>({imageUrl:"",recognizing:!1,todayCount:0,totalCount:0,showForm:!1,buildingIndex:0,buildingOptions:["1号楼","2号楼","3号楼","4号楼","5号楼","6号楼","7号楼","8号楼","9号楼","10号楼","11号楼","12号楼"],formData:{building:"1号楼",detailAddress:"",remarks:""},shootingTips:[{title:"光线充足",desc:"确保燃气表数字显示清晰",emoji:"💡"},{title:"水平拍摄",desc:"保持手机与燃气表平行",emoji:"📐"},{title:"完整显示",desc:"确保读数完全显示在画面中",emoji:"🎯"},{title:"避免反光",desc:"防止阴影遮挡数字区域",emoji:"🚫"},{title:"核对读数",desc:"识别后请验证结果准确性",emoji:"✅"}]}),onLoad(){this.loadStatistics()},onShow(){this.loadStatistics()},methods:{async loadStatistics(){try{const t=e.tr.importObject("gasMeter"),o=await t.getReports("全部");if(0===o.errCode){const e=o.data;this.totalCount=e.length;const t=(new Date).toISOString().split("T")[0],i=t.replace(/-/g,"/");this.todayCount=e.filter((e=>e.date===i||e.updateTime&&e.updateTime.startsWith(t))).length}}catch(t){console.log("加载统计数据失败:",t)}},chooseImage(){const t=this;e.index.showActionSheet({itemList:["拍照","从相册选择"],success(e){0===e.tapIndex?t.takePhoto():t.chooseFromAlbum()}})},takePhoto(){const t=this;e.index.chooseImage({count:1,sourceType:["camera"],success(o){t.imageUrl=o.tempFilePaths[0],e.index.showToast({title:"拍照成功，请继续填写信息",icon:"success",duration:1500})},fail(){e.index.showToast({title:"拍照失败，请重试",icon:"none",duration:2e3})}})},chooseFromAlbum(){const t=this;e.index.chooseImage({count:1,sourceType:["album"],success(o){t.imageUrl=o.tempFilePaths[0],e.index.showToast({title:"图片选择成功，请继续填写信息",icon:"success",duration:1500})},fail(){e.index.showToast({title:"选择图片失败，请重试",icon:"none",duration:2e3})}})},clearImage(){this.imageUrl="",this.showForm=!1,this.formData={building:"1号楼",detailAddress:"",remarks:""},this.buildingIndex=0},showInfoForm(){this.showForm=!0},backToPhoto(){this.showForm=!1},onBuildingChange(e){this.buildingIndex=e.detail.value,this.formData.building=this.buildingOptions[e.detail.value]},async confirmAndRecognize(){if(this.imageUrl)if(this.formData.detailAddress.trim()){this.recognizing=!0;try{const o=await this.convertImageToBase64(this.imageUrl);let i="";try{i=(await e.tr.uploadFile({filePath:this.imageUrl,cloudPath:`gas-meter-images/${Date.now()}-${Math.random().toString(36).substr(2,9)}.jpg`,cloudPathAsRealPath:!0})).fileID}catch(t){console.log("图片上传失败，继续进行识别但不保存图片URL:",t)}const a=e.tr.importObject("gasMeter"),s=`${this.formData.building} ${this.formData.detailAddress}`,n=await a.recognizeGasMeter(o,s,this.formData.building,this.formData.remarks,i);if(this.recognizing=!1,0===n.errCode){this.todayCount++,this.totalCount++,e.index.showToast({title:"🎉 识别成功！正在生成报告...",icon:"success",duration:2e3});const t=this.imageUrl,o=this.formData.remarks;this.showForm=!1,this.imageUrl="",this.formData={building:"1号楼",detailAddress:"",remarks:""},this.buildingIndex=0,setTimeout((()=>{e.index.navigateTo({url:`/pages/reportDetail/reportDetail?reportId=${n.data.reportId}&reading=${n.data.reading}&address=${n.data.address}&date=${n.data.date}&time=${n.data.time}&imageUrl=${encodeURIComponent(t)}&integerPart=${n.data.integerPart}&decimalPart=${n.data.decimalPart}&remarks=${encodeURIComponent(o)}`})}),1500)}else e.index.showModal({title:"识别失败",content:n.errMsg||"无法识别燃气表读数，请检查图片是否清晰，确保数字显示完整。",confirmText:"重新拍照",showCancel:!0,cancelText:"稍后再试",success:e=>{e.confirm&&this.clearImage()}})}catch(o){this.recognizing=!1,console.error("识别出错:",o),e.index.showModal({title:"网络错误",content:"识别过程中网络异常，请检查网络连接后重试。",confirmText:"重新识别",showCancel:!0,cancelText:"稍后再试",success:e=>{e.confirm&&this.confirmAndRecognize()}})}}else e.index.showToast({title:"请填写详细地址信息",icon:"none",duration:2e3});else e.index.showToast({title:"请先选择图片",icon:"none"})},convertImageToBase64:t=>new Promise(((o,i)=>{e.index.getFileSystemManager().readFile({filePath:t,encoding:"base64",success:e=>{o(e.data)},fail:e=>{i(e)}})}))}};const o=e._export_sfc(t,[["render",function(t,o,i,a,s,n){return e.e({a:!s.imageUrl},s.imageUrl?{b:s.imageUrl}:{},{c:e.o(((...e)=>n.chooseImage&&n.chooseImage(...e))),d:!s.imageUrl},s.imageUrl?{}:{e:e.o(((...e)=>n.takePhoto&&n.takePhoto(...e))),f:e.o(((...e)=>n.chooseFromAlbum&&n.chooseFromAlbum(...e)))},{g:s.imageUrl&&!s.showForm},s.imageUrl&&!s.showForm?{h:e.o(((...e)=>n.clearImage&&n.clearImage(...e))),i:e.o(((...e)=>n.showInfoForm&&n.showInfoForm(...e)))}:{},{j:s.showForm},s.showForm?{k:e.t(s.buildingOptions[s.buildingIndex]),l:e.o(((...e)=>n.onBuildingChange&&n.onBuildingChange(...e))),m:s.buildingIndex,n:s.buildingOptions,o:s.formData.detailAddress,p:e.o((e=>s.formData.detailAddress=e.detail.value)),q:s.formData.remarks,r:e.o((e=>s.formData.remarks=e.detail.value)),s:e.o(((...e)=>n.backToPhoto&&n.backToPhoto(...e))),t:e.t(s.recognizing?"⏳":"✨"),v:e.t(s.recognizing?"识别中...":"确认识别"),w:s.recognizing?1:"",x:e.o(((...e)=>n.confirmAndRecognize&&n.confirmAndRecognize(...e)))}:{},{y:e.f(s.shootingTips,((t,o,i)=>({a:e.t(o+1),b:e.t(t.title),c:e.t(t.desc),d:e.t(t.emoji),e:o}))),z:e.t(s.todayCount),A:e.t(s.totalCount)})}],["__scopeId","data-v-e74088a2"]]);wx.createPage(o);
